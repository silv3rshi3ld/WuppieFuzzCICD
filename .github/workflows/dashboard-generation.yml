name: Generate Fuzzing Dashboard

on:
  workflow_run:
    workflows: ["Fuzz VAmPI with WuppieFuzz, EvoMaster, RESTler"]
    types:
      - completed
  workflow_dispatch:  # Keep manual trigger for testing

jobs:
  generate-dashboard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download Artifacts
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: wuppiefuzz_fuzz_and_RESTles.yaml
          run_id: ${{ github.event.workflow_run.id }}
          workflow_conclusion: success
          name: |
            evomaster-results
            fuzzing-report
            restler-fuzz-results
          path: output-fuzzers/

      - name: Organize Files
        run: |
          # Move files to their expected locations
          mkdir -p output-fuzzers/{Evomaster,Wuppiefuzz,Restler}
          mv output-fuzzers/evomaster-results/* output-fuzzers/Evomaster/evomaster-results/ || true
          mv output-fuzzers/fuzzing-report/* output-fuzzers/Wuppiefuzz/fuzzing-report/ || true
          mv output-fuzzers/restler-fuzz-results/* output-fuzzers/Restler/restler-fuzz-results/ || true
          
          # Cleanup temporary directories
          rm -rf output-fuzzers/evomaster-results
          rm -rf output-fuzzers/fuzzing-report
          rm -rf output-fuzzers/restler-fuzz-results

      - name: Parse Results and Generate Dashboard
        run: |
          python -m parsers
          python generate_dashboard.py

      - name: Package Dashboard
        run: |
          zip -r fuzzing-dashboard.zip dashboard/

      - name: Upload Dashboard
        uses: actions/upload-artifact@v3
        with:
          name: fuzzing-dashboard
          path: fuzzing-dashboard.zip
          retention-days: 90