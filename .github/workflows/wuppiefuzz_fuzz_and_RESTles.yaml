name: Fuzz VAmPI with WuppieFuzz and EvoMaster

on:
  push:
    branches: [ Less-dependent-build ]
  pull_request:
    branches: [ Less-dependent-build ]

jobs:
  evomaster:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4.2.2

      # 2. Install yq and convert OpenAPI spec
      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Convert OpenAPI spec to JSON
        run: |
          yq eval -o=json 'services/vampi/openapi_specs/openapi3.yml' > services/vampi/openapi_specs/openapi.json

      # 3. Start VAmPI with Docker Compose for EvoMaster
      - name: Start Docker Compose for EvoMaster
        run: docker compose -f services/evomaster/docker-compose.evomaster.yml up -d --build

      # 4. Wait for VAmPI to initialize
      - name: Wait for VAmPI to be healthy
        run: |
          timeout 30s bash -c 'until docker container inspect vampi-evomaster --format "{{.State.Health.Status}}" | grep -q healthy; do sleep 1; done'

      # 5. Run EvoMaster using the GitHub Action
      - name: Run EvoMaster Action
        uses: webfuzzing/evomaster-action@v1.0.0
        with:
          args: >-
            --writeWFCReport true
            --blackBox true
            --bbSwaggerUrl http://localhost:5000/openapi.json
            --maxTime 20s
            --showProgress false
            --problemType REST
            --outputFormat PYTHON_UNITTEST
            --ratePerMinute 60
          failOnErrors: "true"

      # 6. Upload EvoMaster-generated files as an artifact
      - name: Upload EvoMaster Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evomaster-results
          path: ./generated_tests

      # 7. Shut down Docker Compose to stop VAmPI
      - name: Stop Docker Compose for EvoMaster
        if: always()
        run: docker compose -f services/evomaster/docker-compose.evomaster.yml down

  wuppiefuzz:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout your repository.
      - name: Checkout Repository
        uses: actions/checkout@v4.2.2

      # 2. Run VAmPI via Docker in vulnerable mode.
      - name: Start VAmPI Container (Vulnerable Mode)
        run: |
          docker run -d --name vampi -e vulnerable=1 -p 5000:5000 erev0s/vampi:latest
          sleep 10

      # 3. Initialize the VAmPI database.
      - name: Initialize VAmPI Database
        run: |
          curl -s http://localhost:5000/createdb

      # 4. Set up the Rust toolchain.
      - name: Set up Rust Toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      # 5. Clone the WuppieFuzz repository.
      - name: Clone WuppieFuzz
        run: git clone https://github.com/TNO-S3/WuppieFuzz.git

      # 6. Build WuppieFuzz.
      - name: Build WuppieFuzz
        run: |
          cd WuppieFuzz
          cargo build --release

      # 7. Generate an initial corpus from the OpenAPI specification.
      - name: Generate Initial Corpus for Fuzzing
        run: |
          cd WuppieFuzz
          ./target/release/wuppiefuzz output-corpus --openapi-spec ../services/vampi/openapi_specs/openapi3.yml corpus_directory

      # 8. Run the fuzzing campaign.
      - name: Run WuppieFuzz Fuzzing Campaign
        run: |
          cd WuppieFuzz
          ./target/release/wuppiefuzz fuzz \
            --report \
            --log-level info \
            --initial-corpus corpus_directory \
            --timeout 60 \
            ../services/vampi/openapi_specs/openapi3.yml

      # 9. Upload the generated fuzzing reports as an artifact.
      - name: Upload Fuzzing Report
        uses: actions/upload-artifact@v4
        with:
          name: fuzzing-report
          path: WuppieFuzz/reports/
